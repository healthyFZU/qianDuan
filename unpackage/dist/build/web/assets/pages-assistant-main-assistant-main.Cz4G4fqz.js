import{T as s,W as e,R as t,o as a,v as o,U as r,c as i,w as c,H as n,b as l,X as h,F as u,x as d,f as m,I as g,a as p,e as y,t as v,q as b}from"./index-DD8SDI5w.js";import{a as f}from"./axios.CCYSaZn9.js";import{_ as H}from"./background.9mxQRA6f.js";import{_ as k}from"./_plugin-vue_export-helper.BCo6x5W8.js";const w=k({setup(){const o=s(),r=e((()=>o.state.userId)),i=e((()=>o.state.avatar_url)),c=t(i.value||"../../pages/images/logo-black.jpg");a((()=>{r.value&&n(r.value)}));const n=async s=>{try{const e=await f.get(`http://129.204.151.245:5001/user/message/${s}`);e.data&&e.data.avatar_url?(c.value=e.data.avatar_url,o.commit("setAvatar",e.data.avatar_url)):c.value="../../pages/images/logo-black.jpg"}catch(e){console.error("获取用户信息失败:",e),c.value="../../pages/images/logo-black.jpg"}};return{userId:r,userAvatar:c,aiAvatar:"https://static-mp-c43f71ef-961a-42bc-ab24-48758fb2dfb5.next.bspapp.com/image/logo.jpg"}},data:()=>({searchFocused:!1,userInput:"",recommendedQuestions:["帮我生成适合减脂的一周的食谱","水果黄瓜与普通黄瓜的营养成分区别","我不知道今天该吃什么，请帮我选一个","一天最多能吃几个鸡蛋？"],chatHistory:[],showAllHistory:!1,isKeyboardVisible:!1}),computed:{visibleChatHistory(){return this.showAllHistory?this.chatHistory:this.chatHistory.slice(-10)}},methods:{scrollToBottom(){const s=this.$refs.chatHistory;if(!s)return;const e=()=>{s.scrollTop=s.scrollHeight,s.scrollTop+s.clientHeight<s.scrollHeight&&requestAnimationFrame(e)};this.$nextTick((()=>{requestAnimationFrame(e)}))},async changeSuggestions(){try{const s=await f.get("http://129.204.151.245:5001/questions/random");s.data&&s.data.questions?this.recommendedQuestions=s.data.questions:console.error("未获取到问题列表")}catch(s){console.error("获取随机问题失败",s)}},adjustForKeyboard(){window.addEventListener("resize",this.handleResize)},backToRecommendations(){this.searchFocused=!1,this.userInput=""},handleResize(){window.innerHeight<500?this.isKeyboardVisible=!0:this.isKeyboardVisible=!1},onSearchFocus(){this.searchFocused=!0},onSearchBlur(){},selectQuestion(s){this.searchFocused=!0,this.userInput=s,this.sendMessage()},async sendMessage(){if(!this.userInput.trim())return;const s={sender:"user",content:this.userInput.trim()};this.chatHistory.push(s),this.scrollToBottom(),this.userInput="";this.chatHistory.push({sender:"ai",content:"AI正在思考中，请稍候..."}),await this.fetchAIResponse(s.content),this.chatHistory=this.chatHistory.filter((s=>"AI正在思考中，请稍候..."!==s.content)),this.scrollToBottom()},async fetchAIResponse(s){try{const e=await f.post("http://129.204.151.245:5002/ask_question",{user_id:this.userId,question:s});if(e.data.error)throw new Error(e.data.error);const t={sender:"ai",content:e.data.answer||"未获取到回答，请稍后重试"};this.chatHistory.push(t),this.scrollToBottom(),this.saveChatHistory()}catch(e){console.error("AI请求失败",e);const s={sender:"ai",content:"发生错误，请稍后再试。"};this.chatHistory.push(s),this.scrollToBottom()}},saveChatHistory(){localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory))}},beforeDestroy(){window.removeEventListener("resize",this.handleResize)}},[["render",function(s,e,t,a,f,k){const w=m,I=g;return p(),o("div",{class:"chat-interface"},[r("div",{class:"main-image"},[r("img",{src:H,alt:"logo",class:"background-image"})]),f.searchFocused?(p(),i(w,{key:0,class:"back-to-recommendations",onClick:k.backToRecommendations},{default:c((()=>[y(" 回到推荐问题 ")])),_:1},8,["onClick"])):n("",!0),r("div",{class:"search-container"},[l(I,{type:"text",modelValue:f.userInput,"onUpdate:modelValue":e[0]||(e[0]=s=>f.userInput=s),onFocus:k.onSearchFocus,onBlur:k.onSearchBlur,onKeyup:h(k.sendMessage,["enter"]),placeholder:f.searchFocused?"你的每一个饮食疑问都有答案":"关于食物的事情都能问养养哦！",class:"search-box"},null,8,["modelValue","onFocus","onBlur","onKeyup","placeholder"]),f.searchFocused?(p(),i(w,{key:0,onClick:k.sendMessage,class:"send-btn"},{default:c((()=>[y(" 发送 ")])),_:1},8,["onClick"])):n("",!0)]),f.searchFocused?n("",!0):(p(),o("div",{key:1,class:"recommendations"},[r("div",{class:"question-row"},[(p(!0),o(u,null,d(f.recommendedQuestions,((s,e)=>(p(),o("div",{key:e,class:"recommendation-card",onClick:e=>k.selectQuestion(s)},v(s),9,["onClick"])))),128))]),r("div",{class:"change-suggestions",onClick:e[1]||(e[1]=(...s)=>k.changeSuggestions&&k.changeSuggestions(...s))},"🔄 换一批")])),f.searchFocused?(p(),o("div",{key:2,class:"chat-window"},[f.showAllHistory?n("",!0):(p(),o("div",{key:0,class:"history"},[l(w,{class:"show-history-btn",onClick:e[2]||(e[2]=s=>f.showAllHistory=!0)},{default:c((()=>[y("----查看更多历史记录----")])),_:1})])),r("div",{class:"chat-history",ref:"chatHistory"},[(p(!0),o(u,null,d(k.visibleChatHistory,((s,e)=>(p(),o("div",{key:e,class:b("user"===s.sender?"chat-message user":"chat-message ai")},[r("img",{src:"user"===s.sender?a.userAvatar:a.aiAvatar,class:"avatar"},null,8,["src"]),r("div",{class:"message-bubble"},v(s.content),1)],2)))),128))],512)])):n("",!0)])}],["__scopeId","data-v-322a123d"]]);export{w as default};
